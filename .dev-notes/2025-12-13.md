# Development Notes - December 13, 2025

## Summary

Converted `release.mjs` from an opinionated single-file script into a configurable npm package with modular architecture, TypeScript config support, and CLI interface.

## What We Built

### Architecture

```
src/
  index.ts                # Public API exports (defineConfig, runRelease, loadConfig)
  cli.ts                  # CLI entry point using citty
  core/
    types.ts              # TypeScript interfaces for config
    config.ts             # Config loading (TS/JS files + package.json)
    config.test.ts        # Config tests
    runner.ts             # Main workflow orchestrator
  steps/
    index.ts              # Step exports
    branch-check.ts       # Verify release branch
    remote-sync.ts        # Fetch/pull from remote
    test-runner.ts        # Run test command
    git-status.ts         # Check/commit changes
    version-bump.ts       # npm version handling
    push.ts               # Push to remote
  utils/
    exec.ts               # Shell command execution
    exec.test.ts          # Exec tests
    prompts.ts            # Clack prompt helpers
```

### Key Features

1. **TypeScript Config Support** - Users create `release.config.ts` with full autocomplete
2. **Init Command** - `npx release-police init` generates a fully documented config file
3. **Package.json Fallback** - Simple configs via `"releasePolice": {...}` field
4. **Dry-Run Mode** - `--dry-run` flag previews actions without executing
5. **CLI Flags** - Skip individual steps (`--skip-tests`, `--skip-sync`, `--skip-push`)
6. **Pre-select Version** - `--version-type patch|minor|major` for CI usage
7. **Configurable Commands** - Custom test, build, install, changelog commands
8. **GitHub Release Integration** - Create GitHub releases via `gh` CLI

### Config Interface

```typescript
import { defineConfig } from 'release-police';

export default defineConfig({
  releaseBranches: ['main', 'master', 'release/*'],
  commands: {
    test: 'npm run test:all',
    install: 'npm install',
    build: null,
    changelog: null,
  },
  git: {
    pullStrategy: 'rebase', // 'rebase' | 'merge' | 'ff-only'
    requireCleanWorkingDir: true,
  },
  github: {
    release: false,       // opt-in
    draft: true,          // safe default
    generateNotes: true,
  },
  steps: {
    checkBranch: true,
    syncRemote: true,
    runTests: true,
    commitChanges: true,
    versionBump: true,
    push: true,
    githubRelease: false,
  },
});
```

### Dependencies Added

- `citty` - CLI argument parsing (lightweight, from UnJS ecosystem)
- `jiti` - TypeScript config file loading (same as tsup/Vite use)

### Files Modified

- `package.json` - Added bin field, dependencies, updated exports
- `tsup.config.ts` - Dual build (library + CLI)
- `eslint.config.js` - Ignore wrapper files
- `README.md` - Full documentation with examples
- `index.js`, `index.mjs`, `index.d.ts` - Updated wrapper paths

### Files Created

- All files under `src/core/`, `src/steps/`, `src/utils/`
- `src/cli.ts`
- `src/core/init.ts` - Config file generator for `init` command
- `src/steps/github-release.ts` - GitHub release creation step

### Files to Clean Up (Optional)

- `release.mjs` - Original script, logic now in src/steps/*
- `scripts/release.mjs` - If exists, same as above

## Design Decisions

1. **Command strings over hooks** - Start simple with shell commands. Can add async hooks later if users request them.

2. **jiti over cosmiconfig** - Lighter weight, native TS support, same approach as tsup/Vite.

3. **citty over commander** - Modern, lightweight, from UnJS ecosystem.

4. **Modular steps** - Each release step is a separate file for testability and maintainability.

5. **Wrapper files kept** - `index.js`, `index.mjs`, `index.d.ts` provide better IDE import experience (clean `import from 'release-police'` instead of messy paths).

## CLI Usage

```bash
# Generate config file
npx release-police init

# Basic usage
npx release-police

# Preview mode
npx release-police --dry-run

# Skip steps
npx release-police --skip-tests --skip-sync

# CI-friendly (non-interactive)
npx release-police --version-type patch --skip-push

# Create GitHub release after push
npx release-police --github-release
```

## Init Command

Added `init` subcommand to generate a `release.config.ts` file with all available options documented.

**Rationale:** Scaffolders and project generators can programmatically call `npx release-police init` instead of hardcoding config file contents. When the config format is updated, scaffolders automatically get the latest defaults.

**Usage:**
```bash
npx release-police init
```

**Behavior:**
- Creates `release.config.ts` in the current directory
- Includes all options with inline documentation
- Refuses to overwrite existing config files (exit code 1)

## GitHub Release Integration

Added `--github-release` flag and `github` config section to create GitHub releases after push.

**New workflow:**
```
test → commit → version → push → create GitHub release (draft) → CD publishes to npm
```

**Config:**
```typescript
github: {
  release: true,       // Enable
  draft: true,         // Create as draft (recommended)
  generateNotes: true, // Auto-generate from commits
}
```

**Why draft by default:**
1. User can review/edit release notes before publishing
2. Safer - won't accidentally trigger CD workflows
3. Matches the interactive philosophy of release-police

**Requirements:** GitHub CLI (`gh`) must be installed and authenticated.

## Known Issues

### Vitest "No test suite found" in Claude Code

Tests pass locally but Claude Code sees failures. This is a known Vitest bug on Windows with non-C: drives (project is on F:). See:
- https://github.com/vitest-dev/vscode/issues/548
- https://github.com/vitest-dev/vitest/issues/7465

**Tests work fine when run manually** - this is an environment issue, not a code problem.

## Next Steps (Future)

- [x] ~~Add GitHub release integration~~ (done)
- [ ] Add async hooks for advanced users (`beforeTest`, `afterVersion`, etc.)
- [ ] Add `--yes` flag to skip all confirmations
- [ ] Add rollback on failure (undo version bump if push fails)
- [ ] Consider monorepo support
